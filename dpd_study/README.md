# Application of BEDwARS to characterize the cell type-specific regulomes of DPD-deficient patients

In the following, the steps to preprocess the single cell data, generate signatures and pseudo bulk samples for batch correction are explained.
Data related to DPD analyis should be downloaded first. To download the DPD data navigate to `dpd_data` directory and run `./download.sh`. Make sure that you have `gdown` installed. `gdown` is already installed in the virtual environment (venv) created for BEDwARS (read BEDwARS documentation on activating the `venv`). After downling the data, run the notebooks in the represented order. To run the notebooks you need to add Rkernel to jupyter https://izoda.github.io/site/anaconda/r-jupyter-notebook/.

+  <details>
   <summary><strong>Step 1: Quality Control and Clustering</strong></summary>

    Run `qc_clustering.ipynb` to perform quality control and clustering of the single cell data using Scanpy. To reproduce the `anndata (adata)` object generated by the paper all the library versions should match the ones listed in the beginning of the notebook. It is very likely that you cannot reproduce the exact `adata` object, in this case simply load the `adata` object used by the paper to reproduce the results of the paper. Depending on what you choose the sequence of analyses is different as listed below,
   * `load_adata=True`: The `adata` generated by the paper will be loaded from `dpd_data/sc_process/write/DPD_res.h5ad`. As a result, quality control and clustering steps are skipped. You do not need to annotate the clusters with cell types as it has already been done.
   * `load_data=False`: The single cell data will be loaded from `dpd_data/scdata`. The quality control and clustering is performed from scratch. If the clustering is not the same as the clustering presented in the paper, i.e., `load_adata=True`, then you have to do cell type assignment following the procedure explained in the paper. This notebook generates all the data, such as statistically derived markers of each cluster, required to perform cell type assignment. Read "Methods" section of the paper for more details.

   The processed single cell data will be saved to `dpd_results/sc_preprocess/processed_data`. If you cannot reproduce the paper results, the processed single cell data by the paper is located at `dpd_data/sc_preprocess/processed_data`. This data is later used for signature and pseudo-bulk mixture generation.
    
    </details>

+  <details>
   <summary><strong>Step 2: Signature Generation</strong></summary>

   Run `signature_gen.ipynb` to generate signatures using the processed single cell data. Most of the code to generate signatures is adapted from         https://github.com/favilaco/deconv_benchmark. If `adata` of the paper is used in generating the processed single cell data (`all_proc`) in step 1,     load data from `./dpd_data/sc_preprocess/processed_data/all_proc`. If `adata` is generated from scratch load data from                 `./dpd_results/sc_preprocess/processed_data/all_proc`. The signatures will be saved to `dpd_results/signatures/dpd_sig`.
   
   </details>

+  <details>
   <summary><strong>Step 3: Pseudo-Bulk Generation and Batch Correction</strong></summary>
   
   Run `pseudobulk_batchcorr.ipynb` to generate pseudo-bulk samples from the processed single cell data and perform batch correction for bulk RNA-seq     data stored at `dpd_data/bulk_raw_counts`. The batch corrected bulk RNA-seq samples for affected and non-affected (healthy) groups will be             stored at `dpd_results/bulk_preprocess/dpd_affected` and `dpd_results/bulk_preprocess/dpd_healthy`. These files also exist in the downloaded           input files for running BEDwARS (see BEDwARS README). The bootstrapped pseudo-bulk samples will be stored at
   `dpd_results/bulk_preprocess/dpd_bulk_bs` (affected) and `dpd_results/bulk_preprocess/h_bulk_bs` (non-affected).

   Similar as before, if `adata` of the paper is used in generating the processed single cell data, load data from
   `./dpd_data/sc_preprocess/processed_data/all_proc`. If `adata` is generated from scratch, load data from
   `./dpd_results/sc_preprocess/processed_data/all_proc`.

   </details>


+  <details>
   <summary><strong>Step 4: Differential Gene Expression (DGE) Analysis</strong></summary>

   Run `dge_bulk.ipynb` to perform DGE anlaysis on bulk RNAseq, bootstrapped pseudo bulk, and deconvoluted bulk expression profiles per cell       type for affected (72) vs non-affected (48) samples. The results will be stored at `dpd_results/bulk_DGE/DGE_all`. 

   </details>
